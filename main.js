"use strict";var d=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var y=(r,t)=>{for(var e in t)d(r,e,{get:t[e],enumerable:!0})},I=(r,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of m(t))!w.call(r,i)&&i!==e&&d(r,i,{get:()=>t[i],enumerable:!(s=T(t,i))||s.enumerable});return r};var f=r=>I(d({},"__esModule",{value:!0}),r);var x={};y(x,{default:()=>o});module.exports=f(x);var n=require("obsidian"),S={threadsAccessToken:"",delimiter:`
---
`},c="https://graph.threads.net/v1.0",o=class extends n.Plugin{async onload(){this.settings=Object.assign({},S,await this.loadData()),this.addCommand({id:"threads-post-selection-as-thread",name:"Post selection to Threads (as a thread)",callback:()=>this.postSelectionAsThread()}),this.addRibbonIcon("at-sign","Post selection to Threads",()=>{this.postSelectionAsThread()}),this.addSettingTab(new h(this.app,this))}async saveSettings(){await this.saveData(this.settings)}getActiveSelection(){let t=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(!t)return null;let s=(t.editor.getSelection()??"").trim();if(!s)return null;let i=t.file?.basename??"";return{text:s,noteTitle:i}}splitIntoParts(t){let e=this.settings.delimiter??"";return e?t.split(e).map(s=>s.trim()).filter(s=>s.length>0):[t]}async postSelectionAsThread(){let t=this.getActiveSelection();if(!t){new n.Notice("No selection");return}let e=this.settings.threadsAccessToken?.trim();if(!e){new n.Notice("Threads access token is not set. Configure in plugin settings.");return}let s=this.splitIntoParts(t.text);if(s.length===0){new n.Notice("Nothing to post");return}try{let i=await this.getThreadsUserId(e),u=await this.createTextContainer({accessToken:e,userId:i,text:s[0]}),p=await this.publishContainerAndReturnId({accessToken:e,userId:i,creationId:u});for(let a=1;a<s.length;a++){let g=await this.createTextContainer({accessToken:e,userId:i,text:s[a],replyToId:p});p=await this.publishContainerAndReturnId({accessToken:e,userId:i,creationId:g}),await P(350)}new n.Notice(`Posted thread: ${s.length} post(s)`)}catch(i){console.error(i),new n.Notice(`Threads Poster failed: ${String(i)}`)}}async getThreadsUserId(t){let e=await(0,n.requestUrl)({url:`${c}/me?fields=id&access_token=${encodeURIComponent(t)}`,method:"GET"}),s=l(e.text);if(!s?.id)throw new Error(`Could not resolve Threads user id: ${e.text}`);return String(s.id)}async createTextContainer(t){let e={media_type:"TEXT",text:t.text};t.replyToId&&(e.reply_to_id=t.replyToId);let s=await(0,n.requestUrl)({url:`${c}/${encodeURIComponent(t.userId)}/threads`,method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),i=l(s.text);if(!i?.id)throw new Error(`Create container failed: ${s.text}`);return String(i.id)}async publishContainerAndReturnId(t){let e=await(0,n.requestUrl)({url:`${c}/${encodeURIComponent(t.userId)}/threads_publish`,method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({creation_id:t.creationId})}),s=l(e.text);if(s?.error)throw new Error(`Publish failed: ${e.text}`);if(!s?.id)throw new Error(`Publish did not return post id: ${e.text}`);return String(s.id)}},h=class extends n.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Threads Poster"}),new n.Setting(t).setName("Threads access token").setDesc("Long-lived Threads user access token (you generate it yourself).").addText(e=>e.setPlaceholder("EAAB\u2026").setValue(this.plugin.settings.threadsAccessToken).onChange(async s=>{this.plugin.settings.threadsAccessToken=s.trim(),await this.plugin.saveSettings()})),new n.Setting(t).setName("Delimiter").setDesc("Split selection into parts of the same thread (root + replies). Example: \\n---\\n").addText(e=>e.setPlaceholder("\\n---\\n").setValue(this.plugin.settings.delimiter).onChange(async s=>{this.plugin.settings.delimiter=s,await this.plugin.saveSettings()}))}};function l(r){try{return JSON.parse(r)}catch{return null}}function P(r){return new Promise(t=>setTimeout(t,r))}
